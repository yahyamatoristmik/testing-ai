<!-- templates/sast_report/scan_jobs_enhanced.html -->
{% extends 'sast_report/base.html' %}
{% load static %}

{% block title %}Scan Jobs - Enhanced{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>üìã Security Scan Jobs</h2>
            <a href="{% url 'sast_report:trigger_scan' %}" class="btn btn-primary">
                üöÄ New Scan
            </a>
        </div>

        <!-- Filter Section -->
        <div class="card mb-4">
            <div class="card-body">
                <form method="get" class="row g-3">
                    <div class="col-md-4">
                        <label for="status" class="form-label">Status Filter</label>
                        <select name="status" id="status" class="form-select">
                            <option value="all" {% if status_filter == 'all' %}selected{% endif %}>All Statuses</option>
                            <option value="pending" {% if status_filter == 'pending' %}selected{% endif %}>Pending</option>
                            <option value="running" {% if status_filter == 'running' %}selected{% endif %}>Running</option>
                            <option value="completed" {% if status_filter == 'completed' %}selected{% endif %}>Completed</option>
                            <option value="failed" {% if status_filter == 'failed' %}selected{% endif %}>Failed</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="q" class="form-label">Search</label>
                        <input type="text" name="q" id="q" class="form-control" 
                               placeholder="Search by repository or branch..." 
                               value="{{ search_query }}">
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="submit" class="btn btn-outline-primary w-100">Filter</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Scan Jobs Table -->
        <div class="card">
            <div class="card-body">
                {% if scan_jobs_with_progress %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Repository</th>
                                <th>Branch</th>
                                <th>Status</th>
                                <th>Progress</th>
                                <th>Findings</th>
                                <th>Duration</th>
                                <th>Triggered</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in scan_jobs_with_progress %}
                            {% with scan=item.scan progress=item.progress %}
                            <tr id="scan-row-{{ scan.id }}">
                                <td>
                                    <strong>{{ scan.repository.name }}</strong>
                                    {% if scan.schedule %}
                                    <br><small class="text-muted">Scheduled: {{ scan.schedule.name }}</small>
                                    {% endif %}
                                </td>
                                <td>
                                    <code>{{ scan.branch }}</code>
                                </td>
                                <td>
                                    <span class="badge 
                                        {% if scan.status == 'completed' %}bg-success
                                        {% elif scan.status == 'running' %}bg-primary
                                        {% elif scan.status == 'pending' %}bg-secondary
                                        {% elif scan.status == 'failed' %}bg-danger
                                        {% else %}bg-warning{% endif %}">
                                        {{ scan.status|title }}
                                    </span>
                                </td>
                                <td>
                                    <!-- Progress Bar -->
                                    <div class="progress" style="height: 20px;">
                                        <div class="progress-bar 
                                            {% if scan.status == 'completed' %}bg-success
                                            {% elif scan.status == 'running' %}bg-primary progress-bar-striped progress-bar-animated
                                            {% elif scan.status == 'failed' %}bg-danger
                                            {% else %}bg-secondary{% endif %}" 
                                            role="progressbar" 
                                            style="width: {{ progress.percentage }}%;"
                                            aria-valuenow="{{ progress.percentage }}" 
                                            aria-valuemin="0" 
                                            aria-valuemax="100">
                                            {{ progress.percentage }}%
                                        </div>
                                    </div>
                                    <small class="text-muted">{{ progress.stage }}</small>
                                </td>
                                <td>
                                    {% if scan.status == 'completed' %}
                                        {% if scan.findings_count > 0 %}
                                        <span class="badge bg-danger">{{ scan.findings_count }} findings</span>
                                        {% else %}
                                        <span class="badge bg-success">Clean</span>
                                        {% endif %}
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {{ scan.get_duration_display }}
                                </td>
                                <td>
                                    <small>{{ scan.triggered_at|timesince }} ago</small>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a href="{% url 'sast_report:scan_detail' scan.id %}" 
                                           class="btn btn-outline-primary" title="View Details">
                                            üëÅÔ∏è
                                        </a>
                                        {% if scan.status == 'completed' %}
                                        <a href="{% url 'sast_report:vulnerability_report' scan.id %}" 
                                           class="btn btn-outline-success" title="View Report">
                                            üìä
                                        </a>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endwith %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <h4>No scan jobs found</h4>
                    <p class="text-muted">Start your first security scan to see results here.</p>
                    <a href="{% url 'sast_report:trigger_scan' %}" class="btn btn-primary">
                        üöÄ Start Your First Scan
                    </a>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Auto-refresh for running scans -->
        {% if scan_jobs_with_progress %}
        <div class="mt-3 text-center">
            <small class="text-muted">
                üîÑ Page auto-refreshes every 10 seconds for running scans
            </small>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Auto-refresh for running scans
function checkRunningScans() {
    let hasRunningScans = false;
    {% for item in scan_jobs_with_progress %}
        {% if item.scan.status == 'running' or item.scan.status == 'pending' %}
            hasRunningScans = true;
        {% endif %}
    {% endfor %}
    
    if (hasRunningScans) {
        setTimeout(function() {
            window.location.reload();
        }, 10000); // Refresh every 10 seconds
    }
}

// Initial check
document.addEventListener('DOMContentLoaded', function() {
    checkRunningScans();
    
    // Add progress animation for running scans
    const progressBars = document.querySelectorAll('.progress-bar');
    progressBars.forEach(bar => {
        if (bar.classList.contains('progress-bar-animated')) {
            bar.style.width = bar.style.width; // Trigger animation
        }
    });
});
</script>
{% endblock %}
