{% extends "admin/change_list.html" %}
{% load i18n admin_urls static admin_list %}

{% block extrastyle %}
    {{ block.super }}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .dashboard-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            margin-bottom: 25px;
            border-radius: 10px;
        }
        
        .dashboard-header h1 {
            margin: 0 0 10px 0;
            font-size: 28px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .dashboard-header p {
            margin: 0;
            opacity: 0.9;
            font-size: 16px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            text-align: center;
            border-left: 4px solid #667eea;
            transition: transform 0.2s;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
        }
        
        .stat-card h3 {
            margin: 0 0 10px 0;
            color: #666;
            font-size: 14px;
            text-transform: uppercase;
            font-weight: 600;
        }
        
        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: #333;
            margin: 0;
        }
        
        .stat-icon {
            font-size: 24px;
            margin-bottom: 10px;
            color: #667eea;
        }
        
        .quick-actions {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .quick-actions h3 {
            margin: 0 0 15px 0;
            color: #333;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .action-button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        
        .action-button.primary {
            background: #007bff;
            color: white;
        }
        
        .action-button.success {
            background: #28a745;
            color: white;
        }
        
        .action-button.warning {
            background: #ffc107;
            color: #212529;
        }
        
        .action-button:hover {
            opacity: 0.9;
            text-decoration: none;
            color: white;
        }
        
        .risk-badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .risk-high { background: #dc3545; color: white; }
        .risk-medium { background: #fd7e14; color: white; }
        .risk-low { background: #ffc107; color: #212529; }
        .risk-info { background: #17a2b8; color: white; }
        
        .auto-refresh-info {
            background: #e6f7ff;
            border-left: 4px solid #1890ff;
            padding: 12px 15px;
            margin-bottom: 15px;
            border-radius: 4px;
        }
        .refresh-countdown {
            font-weight: bold;
            color: #1890ff;
        }
        .no-refresh-message {
            background: #f8f9fa;
            border-left: 4px solid #6c757d;
            padding: 12px 15px;
            margin-bottom: 15px;
            border-radius: 4px;
        }

        /* ‚úÖ TAMBAHAN: Loading styles untuk AI generation */
        .generate-ai-loading {
            display: inline-block;
            padding: 5px 10px;
            background: #ffc107;
            color: #000;
            border-radius: 5px;
            cursor: not-allowed;
            opacity: 0.7;
        }
        
        .generate-ai-loading i {
            animation: spin 1s linear infinite;
            margin-right: 5px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .custom-message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 5px;
            color: white;
            z-index: 10000;
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            max-width: 400px;
        }
        
        .custom-message.success { background: #28a745; }
        .custom-message.error { background: #dc3545; }
    </style>
{% endblock %}

{% block content %}
    <!-- Dashboard Header -->
    <div class="dashboard-header">
        <h1><i class="fas fa-shield-alt"></i> DAST Scan Reports</h1>
        <p>Dynamic Application Security Testing - Comprehensive Security Dashboard</p>
    </div>

    <!-- ==================== IP INFO BANNER ==================== -->
    {% if current_ip %}
    <div class="ip-info-banner" style="
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px 20px;
        margin-bottom: 20px;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        border-left: 4px solid #ffd700;
    ">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h4 style="margin: 0 0 5px 0; font-size: 16px; display: flex; align-items: center;">
                    <span style="margin-right: 8px;">üåê</span> Informasi Keamanan Login
                </h4>
                <p style="margin: 0; font-size: 14px; opacity: 0.9;">
                    <strong>IP Address Anda:</strong> <code style="background: rgba(255,255,255,0.2); padding: 2px 6px; border-radius: 4px;">{{ current_ip }} | demi keamanan kami mencatat semua ip dan activitas anda,terima kasih </code>
                </p>
            </div>
            <div style="text-align: right; font-size: 12px; opacity: 0.8;">
                <div>User: <strong>{{ user.username }}</strong></div>
                <div>Role: <strong>{% if user.is_superuser %}Administrator{% else %}User{% endif %}</strong></div>
            </div>
        </div>
    </div>
    {% endif %}
    <!-- ==================== END IP INFO BANNER ==================== -->
    
    <!-- Auto-refresh Info -->
    {% if has_running_scans %}
    <div class="auto-refresh-info">
        <strong>üîÑ Auto-refresh Enabled</strong>
        <p style="margin: 5px 0 0 0; font-size: 13px; color: #333;">
            Halaman akan refresh otomatis dalam <span id="refresh-countdown" class="refresh-countdown">30</span> detik. 
            Status scan running akan otomatis update ke completed ketika semua proses telah selesai.
        </p>
    </div>
    {% else %}
    <div class="no-refresh-message">
        <strong>‚úÖ Semua Scan Selesai</strong>
        <p style="margin: 5px 0 0 0; font-size: 13px; color: #333;">
            Tidak ada scan yang sedang berjalan. Auto-refresh dinonaktifkan.
        </p>
    </div>
    {% endif %}
    
    <!-- Statistics Grid -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon"><i class="fas fa-bug"></i></div>
            <h3>Total Vulnerabilities</h3>
            <p class="stat-number">{{ total_vulnerabilities }}</p>
        </div>
        <div class="stat-card">
            <div class="stat-icon"><i class="fas fa-check-circle"></i></div>
            <h3>Completed Scans</h3>
            <p class="stat-number">{{ completed_scans }}</p>
        </div>
        <div class="stat-card">
            <div class="stat-icon"><i class="fas fa-play-circle"></i></div>
            <h3>Running Scans</h3>
            <p class="stat-number">{{ running_scans }}</p>
        </div>
        <div class="stat-card">
            <div class="stat-icon"><i class="fas fa-exclamation-triangle"></i></div>
            <h3>High Risk Vulnerabilities</h3>
            <p class="stat-number">{{ high_vulnerabilities }}</p>
        </div>
    </div>
    
    <!-- Quick Actions -->
    <div class="quick-actions">
        <h3><i class="fas fa-bolt"></i> Quick Actions</h3>
        <div class="action-buttons">
            <a href="{% url 'admin:dast_reports_dastscan_add' %}" class="action-button primary">
                <i class="fas fa-plus"></i> New Scan
            </a>
            <a href="#" class="action-button success">
                <i class="fas fa-sync"></i> Run All Pending
            </a>
            <a href="#" class="action-button warning">
                <i class="fas fa-download"></i> Export Reports
            </a>
        </div>
    </div>
    
    <!-- Default Admin Content -->
    {{ block.super }}
{% endblock %}

{% block extrajs %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('DAST Scan Dashboard loaded successfully');

    // Add refresh button functionality
    const refreshBtn = document.createElement('button');
    refreshBtn.innerHTML = '<i class="fas fa-sync"></i> Refresh';
    refreshBtn.className = 'button';
    refreshBtn.style.marginLeft = '10px';
    refreshBtn.onclick = function() { location.reload(); };

    const objectTools = document.querySelector('.object-tools');
    if (objectTools) {
        objectTools.appendChild(refreshBtn);
    }

    // Panggil function untuk set default values
    function setDefaultFormValues() {
        const activeField = document.querySelector('#id_active');
        const scheduledField = document.querySelector('#id_scheduled');

        if (activeField) {
            const urlParams = new URLSearchParams(window.location.search);
            const objectId = urlParams.get('id') || window.location.pathname.split('/').filter(Boolean).pop();
            
            if (!objectId || objectId === 'add' || objectId === 'add/') {
                activeField.checked = true;
            } else if (activeField.value === '') {
                activeField.checked = true;
            }
        }

        if (scheduledField) {
            const urlParams = new URLSearchParams(window.location.search);
            const objectId = urlParams.get('id') || window.location.pathname.split('/').filter(Boolean).pop();
            
            if (!objectId || objectId === 'add' || objectId === 'add/') {
                scheduledField.checked = false;
            } else if (scheduledField.value === '') {
                scheduledField.checked = false;
            }
        }
    }
    setDefaultFormValues();
    
    // ‚≠ê‚≠ê SMART REFRESH SYSTEM - DITEMPATKAN DI SINI ‚≠ê‚≠ê
    {% if has_running_scans %}
    // Smart refresh system
    let refreshInterval = 30000; // 30 detik
    let countdown = refreshInterval / 1000;
    const countdownElement = document.getElementById('refresh-countdown');

    function updateCountdown() {
        countdown--;
        if (countdownElement) {
            countdownElement.textContent = countdown;
        }
    }

    function checkIfRefreshNeeded() {
        fetch('/dast_reports/check-running-scans/')
            .then(response => response.json())
            .then(data => {
                if (!data.has_running_scans) {
                    console.log('No running scans found, stopping auto-refresh');
                    clearInterval(countdownTimer);
                    clearInterval(checkInterval);
                    if (countdownElement) {
                        countdownElement.textContent = '0';
                        countdownElement.parentElement.innerHTML = 
                            '<strong>‚úÖ Semua Scan Selesai</strong><p>Auto-refresh dimatikan.</p>';
                    }
                }
            })
            .catch(error => {
                console.log('Error checking running scans:', error);
            });
    }

    // Start countdown timer
    const countdownTimer = setInterval(() => {
        updateCountdown();
        if (countdown <= 0) {
            location.reload();
        }
    }, 1000);

    // Check every 10 seconds if refresh is still needed
    const checkInterval = setInterval(checkIfRefreshNeeded, 10000);

    // Initial check
    checkIfRefreshNeeded();
    {% endif %}
    // ‚≠ê‚≠ê END OF SMART REFRESH CODE ‚≠ê‚≠ê

    // ‚úÖ TAMBAHAN BARU: Handle AI generation clicks
    document.addEventListener('click', function(e) {
        const generateLink = e.target.closest('a[href*=\"generate-ai-recommendations\"]');
        if (generateLink) {
            e.preventDefault();
            
            // Show loading state
            const originalHtml = generateLink.innerHTML;
            generateLink.innerHTML = '<i class=\"fas fa-spinner\"></i> Generating...';
            generateLink.classList.add('generate-ai-loading');
            generateLink.style.pointerEvents = 'none';
            
            // Get the URL
            const url = generateLink.getAttribute('href');
            
            // Send AJAX request
            fetch(url, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'success') {
                    showMessage('AI recommendations generated successfully! Reloading...', 'success');
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                } else {
                    showMessage(data.message || 'Failed to generate AI recommendations', 'error');
                    resetButtonState(generateLink, originalHtml);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('An error occurred while generating AI recommendations', 'error');
                resetButtonState(generateLink, originalHtml);
            });
        }
    });
    
    function resetButtonState(button, originalHtml) {
        button.innerHTML = originalHtml;
        button.classList.remove('generate-ai-loading');
        button.style.pointerEvents = 'auto';
    }
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    function showMessage(message, type) {
        // Remove existing messages
        const existingMessages = document.querySelectorAll('.custom-message');
        existingMessages.forEach(msg => msg.remove());
        
        // Create new message
        const messageDiv = document.createElement('div');
        messageDiv.className = `custom-message ${type}`;
        messageDiv.innerHTML = `
            <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i>
            ${message}
        `;
        
        document.body.appendChild(messageDiv);
        
        // Auto remove after 5 seconds
        setTimeout(() => {
            if (messageDiv.parentNode) {
                messageDiv.parentNode.removeChild(messageDiv);
            }
        }, 5000);
    }
});
</script>
{% endblock %}


{% block extrahead %}
    {{ block.super }}
    <style>
        .ip-info-banner {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Style untuk message info */
        .ip-message {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 10px 15px;
            margin: 10px 0;
            border-radius: 4px;
        }
    </style>
{% endblock %}
